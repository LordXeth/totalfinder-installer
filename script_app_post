#!/bin/sh

# replace /Applications/TotalFinder.app with pre-Yosemite version, if needed
TMP=`sw_vers -productVersion|grep '10\.\(8\|9\)'`
if [ $? -eq 0 ]; then
  rm -rf /Applications/TotalFinder.app
  cp -a /Library/ScriptingAdditions/TotalFinder.osax/Contents/Resources/Agent/10.9/TotalFinder.app /Applications
fi

# add /Applications/TotalFinder.app in user's login items
osascript -e 'tell application "System Events"' -e 'make login item at end with properties { name:"TotalFinder", path:"/Applications/TotalFinder.app", kind:"application", hidden:false }' -e 'end tell'

# tweak finder settings to play nice with TotalFinder
/usr/bin/defaults write com.apple.finder DisableAllAnimations -bool true
/usr/bin/defaults write com.apple.finder _FXShowPosixPathInTitle -bool false
/usr/bin/defaults write com.apple.finder AnimateWindowZoom -bool false
/usr/bin/defaults write com.apple.finder FXDisableFancyWindowTransition -bool true

sleep 2

# the goal here is to relaunch Finder.app under the right user aka "Mach bootstrap namespace"
# note: we can have multiple users logged in concruently (for fast user switching), each has its own loginwindow process
# in $OUTPUT we will list all loginwindow processes and pick only the one belonging to the currently logged-in user
USERID=`id -u "$USER"`
OUTPUT=`ps -lax | grep '[l]oginwindow.app' | grep "^[ ]*$USERID "`
if [ -n "$OUTPUT" ]; then
  set - $OUTPUT
  PID=$2

  echo "login window user name is \"$USER\" and PID is \"$PID\""

  if [[ -n "$USER" && -n "$PID" ]]; then
    /bin/launchctl bsexec "$PID" /usr/bin/env -i /usr/bin/su "$USER" -c "/usr/bin/open /Applications/TotalFinder.app"
  fi
fi
