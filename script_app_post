#!/bin/sh

# add /Applications/TotalFinder.app in user's login items
osascript -e 'tell application "System Events"' -e 'make login item at beginning with properties {path:"/Applications/TotalFinder.app", kind:application}' -e 'end tell'

# tweak finder settings to play nice with TotalFinder
/usr/bin/defaults write com.apple.finder DisableAllAnimations -bool true
/usr/bin/defaults write com.apple.finder _FXShowPosixPathInTitle -bool false
/usr/bin/defaults write com.apple.finder AnimateWindowZoom -bool false
/usr/bin/defaults write com.apple.finder FXDisableFancyWindowTransition -bool true

sleep 2

# note: between 1.4.10 and 1.4.11, structure off app bundle changed, this caused some upgrading problems
#
# the original code:
# /usr/bin/su "$USER" -c "/usr/bin/open /Applications/TotalFinder.app"
#
# What is the problem?
#
# I'm trying to launch TotalFinder.app via open command. Unfortunately I
# renamed the executable inside TotalFinder.app bundle between 1.4.10
# and 1.4.11 (Previous TotalFinder.app was generated by AppleScript
# Editor)
#
# /Applications/TotalFinder.app/Contents/MacOS/applet
# changed to
# /Applications/TotalFinder.app/Contents/MacOS/TotalFinder
#
# But system probably caches all .app bundles in memory for faster
# execution. It is trying to launch old binary "applet" which is not
# there. I wonder why the cache is not refreshed, but this has probably
# something to do with the installer, which updates the bundle in-place
# without notice.

# Current solution:
# 1. delete whole /Applications/TotalFinder.app in pre-flight (thanks Brian)
# 2. launch binary directly (using nohup)
#
# http://getsatisfaction.com/binaryage/topics/totalterminal_installer_setting_tmpdir_to_nonexisting_pkinstallsandbox

/usr/bin/su "$USER" -c "nohup /Applications/TotalFinder.app/Contents/MacOS/TotalFinder >>/dev/null 2>>/dev/null &"